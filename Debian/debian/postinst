#!/bin/bash
# postinst script for linuxmuster
#
# see: dh_installdeb(1)

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package
#

# Source debconf library.
#. /usr/share/debconf/confmodule

#db_version 2.0


LINBODIR=/var/linbo
PXELINUX0=/usr/lib/syslinux/pxelinux.0
DISTCONF=/usr/share/linuxmuster/config/dist.conf

case "$1" in

    configure)

	# pxelinux link
	if [ -e "$PXELINUX0" ]; then
		[ -e "$LINBODIR/pxelinux.0" ] || ln -s $PXELINUX0 $LINBODIR/pxelinux.0
	else
		echo "Error: $PXELINUX0 not found!"
	fi

	# repair link to examples
	[ ! -L "$LINBODIR/examples" -a -e "$LINBODIR/examples" ] && rm -rf $LINBODIR/examples
	[ -e "$LINBODIR/examples" ] || ln -s /usr/share/doc/linuxmuster-linbo/examples $LINBODIR/examples

	# init script
	update-rc.d linbo-multicast defaults

	# linuxmuster related stuff
	if [ -e "$DISTCONF" ]; then
		. $DISTCONF
		. $HELPERFUNCTIONS
		[ "$imaging" = "linbo" ] || exit 0
		LINBOLOGDIR="$LOGDIR/linbo"
	else
		exit 0
	fi

	# check serverip in default pxegrub.lst and start.conf
	if ! grep ^Server $LINBODEFAULTCONF | grep -q "$serverip"; then
		echo "Adjusting server ip in $LINBODEFAULTCONF to $serverip ..."
		cp $LINBODEFAULTCONF $LINBODEFAULTCONF.dpkg-old
		sed -e "s/^Server = \([0-9]\{1,3\}[.]\)\{3\}[0-9]\{1,3\}/Server = $serverip/" -i $LINBODEFAULTCONF
	fi
	for i in $PXEGRUBCFG $PXELINUXCFG; do
		if grep -q "server=" $i; then
			if ! grep -q "$serverip" $i; then
				echo "Adjusting server ip in $i to $serverip ..."
				cp $i $i.dpkg-old
				sed -e "s/server=\([0-9]\{1,3\}[.]\)\{3\}[0-9]\{1,3\}/server=$serverip/g" -i $i
			fi
		fi
	done

	# substitute start.conf option RemoteSyncEnabled with NewEnabled
	for i in `find $LINBODIR -type f -name start.conf.\*`; do
		if grep -q RemoteSyncEnabled $i; then
			sed -e 's/RemoteSyncEnabled/NewEnabled/g' -i $i
		fi
	done

	# check for linbo mail wrapper in /etc/aliases
	if ! grep -q ^linbo: /etc/aliases; then
		cp /etc/aliases /etc/aliases.dpkg-old
		sed -e "/^root:/a\
linbo: \"\|\/usr\/share\/linuxmuster-linbo\/mail2log.sh\"" -i /etc/aliases
		newaliases
	fi

	# change owner of logdir to nobody
	[ -d "$LINBOLOGDIR" ] || mkdir -p $LINBOLOGDIR
	chown nobody $LINBOLOGDIR

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)

    ;;

    *)
	echo "postinst called with unknown argument \`$1'" >&2
	exit 1
    ;;

esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

#db_stop

exit 0

